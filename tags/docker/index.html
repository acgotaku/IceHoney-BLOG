<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>docker Tag | IceHoney</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.png">
    <link rel="manifest" href="/manifest.json">
    <script async="true" src="https://www.googletagmanager.com/gtag/js?id=G-XS3V4JFZ2P"></script>
    <script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XS3V4JFZ2P');</script>
    <link rel="alternate" type="application/rss+xml" href="https://blog.icehoney.me/rss.xml" title="IceHoney RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="https://blog.icehoney.me/feed.atom" title="IceHoney Atom Feed">
    <link rel="alternate" type="application/json" href="https://blog.icehoney.me/feed.json" title="IceHoney JSON Feed">
    <meta name="description" content="IceHoney是雪月秋水君的博客~ 记录秋水君生活的点点滴滴~">
    <meta name="theme-color" content="#8191f1">
    
    <link rel="preload" href="/assets/css/0.styles.730c98a2.css" as="style"><link rel="preload" href="/assets/js/app.978b3ff5.js" as="script"><link rel="preload" href="/assets/js/4.d187b6e6.js" as="script"><link rel="preload" href="/assets/js/106.2cf3e4f6.js" as="script"><link rel="preload" href="/assets/js/84.b4020175.js" as="script"><link rel="prefetch" href="/assets/js/10.8937e099.js"><link rel="prefetch" href="/assets/js/100.102b44f1.js"><link rel="prefetch" href="/assets/js/101.e5db0b25.js"><link rel="prefetch" href="/assets/js/102.cae557ad.js"><link rel="prefetch" href="/assets/js/103.409f06c7.js"><link rel="prefetch" href="/assets/js/104.40560a4e.js"><link rel="prefetch" href="/assets/js/105.ffaee858.js"><link rel="prefetch" href="/assets/js/107.25bcc947.js"><link rel="prefetch" href="/assets/js/108.b270ae61.js"><link rel="prefetch" href="/assets/js/109.c4babc32.js"><link rel="prefetch" href="/assets/js/11.90f3df78.js"><link rel="prefetch" href="/assets/js/110.a7fad859.js"><link rel="prefetch" href="/assets/js/111.64e1f534.js"><link rel="prefetch" href="/assets/js/112.34cf6b68.js"><link rel="prefetch" href="/assets/js/113.d0ebac7e.js"><link rel="prefetch" href="/assets/js/114.8c640b84.js"><link rel="prefetch" href="/assets/js/115.33668e22.js"><link rel="prefetch" href="/assets/js/116.72a9fa41.js"><link rel="prefetch" href="/assets/js/117.50c5538c.js"><link rel="prefetch" href="/assets/js/118.83efcea3.js"><link rel="prefetch" href="/assets/js/119.559a4adf.js"><link rel="prefetch" href="/assets/js/12.5ae7a77b.js"><link rel="prefetch" href="/assets/js/120.98b19fe7.js"><link rel="prefetch" href="/assets/js/121.f62a47cf.js"><link rel="prefetch" href="/assets/js/122.e95c1301.js"><link rel="prefetch" href="/assets/js/13.5ebf56e3.js"><link rel="prefetch" href="/assets/js/14.466be084.js"><link rel="prefetch" href="/assets/js/15.fb59bf50.js"><link rel="prefetch" href="/assets/js/16.1739f39c.js"><link rel="prefetch" href="/assets/js/17.b20a45a2.js"><link rel="prefetch" href="/assets/js/18.baae3b62.js"><link rel="prefetch" href="/assets/js/19.b2ed87b2.js"><link rel="prefetch" href="/assets/js/2.0c916b00.js"><link rel="prefetch" href="/assets/js/20.3c687811.js"><link rel="prefetch" href="/assets/js/21.5ef9b126.js"><link rel="prefetch" href="/assets/js/22.1c3bac2b.js"><link rel="prefetch" href="/assets/js/23.7d87817a.js"><link rel="prefetch" href="/assets/js/24.6046b35f.js"><link rel="prefetch" href="/assets/js/25.5bdff326.js"><link rel="prefetch" href="/assets/js/26.698376c5.js"><link rel="prefetch" href="/assets/js/27.30bca366.js"><link rel="prefetch" href="/assets/js/28.c56d6bc6.js"><link rel="prefetch" href="/assets/js/29.dd5bc508.js"><link rel="prefetch" href="/assets/js/3.b5a1fd8f.js"><link rel="prefetch" href="/assets/js/30.36188359.js"><link rel="prefetch" href="/assets/js/31.76cfeb9a.js"><link rel="prefetch" href="/assets/js/32.ae4b80b3.js"><link rel="prefetch" href="/assets/js/33.a4fd6026.js"><link rel="prefetch" href="/assets/js/34.7bd9c346.js"><link rel="prefetch" href="/assets/js/35.a669c5b2.js"><link rel="prefetch" href="/assets/js/36.30722918.js"><link rel="prefetch" href="/assets/js/37.acb43f18.js"><link rel="prefetch" href="/assets/js/38.e4b5e8c7.js"><link rel="prefetch" href="/assets/js/39.a6820651.js"><link rel="prefetch" href="/assets/js/40.65bd2ca2.js"><link rel="prefetch" href="/assets/js/41.1e2bf6fb.js"><link rel="prefetch" href="/assets/js/42.dc05a682.js"><link rel="prefetch" href="/assets/js/43.be431d30.js"><link rel="prefetch" href="/assets/js/44.0e0291bd.js"><link rel="prefetch" href="/assets/js/45.2d4db3c6.js"><link rel="prefetch" href="/assets/js/46.aacb4e08.js"><link rel="prefetch" href="/assets/js/47.efaf5a02.js"><link rel="prefetch" href="/assets/js/48.278cac02.js"><link rel="prefetch" href="/assets/js/49.75d75a6a.js"><link rel="prefetch" href="/assets/js/5.1fc1e6bf.js"><link rel="prefetch" href="/assets/js/50.24ca70c1.js"><link rel="prefetch" href="/assets/js/51.baa35b59.js"><link rel="prefetch" href="/assets/js/52.43efcdfc.js"><link rel="prefetch" href="/assets/js/53.aee0e5c5.js"><link rel="prefetch" href="/assets/js/54.a6f25dfd.js"><link rel="prefetch" href="/assets/js/55.00dc2829.js"><link rel="prefetch" href="/assets/js/56.09cc1b04.js"><link rel="prefetch" href="/assets/js/57.814eaa5d.js"><link rel="prefetch" href="/assets/js/58.a5eaea6e.js"><link rel="prefetch" href="/assets/js/59.2dac692b.js"><link rel="prefetch" href="/assets/js/6.a947c8d5.js"><link rel="prefetch" href="/assets/js/60.a5e20217.js"><link rel="prefetch" href="/assets/js/61.fbfe9b68.js"><link rel="prefetch" href="/assets/js/62.f573f1d7.js"><link rel="prefetch" href="/assets/js/63.4f035bd5.js"><link rel="prefetch" href="/assets/js/64.c4bb706e.js"><link rel="prefetch" href="/assets/js/65.8ab7b23c.js"><link rel="prefetch" href="/assets/js/66.9f1fa3e4.js"><link rel="prefetch" href="/assets/js/67.4498b5fa.js"><link rel="prefetch" href="/assets/js/68.e60e2863.js"><link rel="prefetch" href="/assets/js/69.0680daad.js"><link rel="prefetch" href="/assets/js/7.5328590c.js"><link rel="prefetch" href="/assets/js/70.0fee6f9e.js"><link rel="prefetch" href="/assets/js/71.a7e8d3ca.js"><link rel="prefetch" href="/assets/js/72.e11204f8.js"><link rel="prefetch" href="/assets/js/73.2d65aad1.js"><link rel="prefetch" href="/assets/js/74.3746c5f0.js"><link rel="prefetch" href="/assets/js/75.37c844cf.js"><link rel="prefetch" href="/assets/js/76.a407a20c.js"><link rel="prefetch" href="/assets/js/77.79fc1650.js"><link rel="prefetch" href="/assets/js/78.1cc2e3ee.js"><link rel="prefetch" href="/assets/js/79.25311307.js"><link rel="prefetch" href="/assets/js/8.af274627.js"><link rel="prefetch" href="/assets/js/80.4506becc.js"><link rel="prefetch" href="/assets/js/81.2a95daa4.js"><link rel="prefetch" href="/assets/js/82.7695731e.js"><link rel="prefetch" href="/assets/js/83.88b01cee.js"><link rel="prefetch" href="/assets/js/85.07e71944.js"><link rel="prefetch" href="/assets/js/86.9e994fcc.js"><link rel="prefetch" href="/assets/js/87.3a001a0d.js"><link rel="prefetch" href="/assets/js/88.718ccb04.js"><link rel="prefetch" href="/assets/js/89.582f540f.js"><link rel="prefetch" href="/assets/js/9.bbb38694.js"><link rel="prefetch" href="/assets/js/90.0a57cf81.js"><link rel="prefetch" href="/assets/js/91.6aebfdf7.js"><link rel="prefetch" href="/assets/js/92.df9984d7.js"><link rel="prefetch" href="/assets/js/93.5b6db62d.js"><link rel="prefetch" href="/assets/js/94.10525bce.js"><link rel="prefetch" href="/assets/js/95.70ef29b9.js"><link rel="prefetch" href="/assets/js/96.ce0a06e8.js"><link rel="prefetch" href="/assets/js/97.734530be.js"><link rel="prefetch" href="/assets/js/98.bd5fb077.js"><link rel="prefetch" href="/assets/js/99.c1cd0603.js">
    <link rel="stylesheet" href="/assets/css/0.styles.730c98a2.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="global-layout"><header class="header"><div class="header-inner"><div class="title"><a href="/" class="nav-link home-link"><img src="/profile.png" alt="IceHoney" class="profile"> <span>IceHoney </span></a></div> <div class="header-right-wrap"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <ul class="nav"><li class="nav-item"><a href="/" class="nav-link">Home</a></li><li class="nav-item"><a href="/archives/" class="nav-link">Archives</a></li><li class="nav-item"><a href="/tags/" class="nav-link router-link-active">Tags</a></li><li class="nav-item"><a href="/friends/" class="nav-link">Friends</a></li><li class="nav-item"><a href="/about/" class="nav-link">About</a></li> <li class="nav-item"><a href="/rss.xml" target="_blank" class="nav-link"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-rss"><path d="M4 11a9 9 0 0 1 9 9"></path><path d="M4 4a16 16 0 0 1 16 16"></path><circle cx="5" cy="19" r="1"></circle></svg></a></li></ul></div></div></header> <div class="mobile-header"><div class="mobile-header-bar"><div class="mobile-header-title"><a href="/" class="nav-link mobile-home-link">IceHoney </a> <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mobile-header-icon feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg></div> <div class="mobile-menu-wrapper"><ul class="mobile-nav"><li class="mobile-nav-item"><a href="/" class="nav-link">Home</a></li><li class="mobile-nav-item"><a href="/archives/" class="nav-link">Archives</a></li><li class="mobile-nav-item"><a href="/tags/" class="nav-link router-link-active">Tags</a></li><li class="mobile-nav-item"><a href="/friends/" class="nav-link">Friends</a></li><li class="mobile-nav-item"><a href="/about/" class="nav-link">About</a></li></ul></div></div></div> <div class="content-wrapper"><main class="container"><section itemscope="itemscope" itemtype="http://schema.org/Blog" class="content"><h1 class="tags-header">
    docker
  </h1> <article class="article"><h1 class="article-title"><a href="/posts/2021-09-09-slim-docker-image/">
          如何瘦身docker镜像
        </a></h1> <div class="post-meta"><div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> <time pubdate itemprop="datePublished" datetime="2021-09-09 21:44">
      2021-09-09 21:44
    </time></div> <div itemprop="keywords" class="post-meta-tags"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg> <a href="/tags/docker" aria-current="page" class="post-tag router-link-exact-active router-link-active"> docker </a></div></div> <div class="content__default"><p>容器化部署已经成为现在的主流，打包 docker 镜像已经是现代前端开发的必修课了。最近正好在做新项目的时候处理过相关事情，所以记录一下。</p> <h2 id="docker-部署的需求"><a href="#docker-部署的需求" class="header-anchor">#</a> docker 部署的需求</h2> <p>首先我们需要使用 docker 完成网站源代码的编译，并且还要自己使用 <a href="https://expressjs.com/" target="_blank" rel="noopener noreferrer">expressjs<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 搭建服务器。让网站可以运行，docker 跑起来之后只用负责端口转发即可。</p> <p>大家都知道前端网站编译需要安装很多依赖，但这些依赖在网站运行的时候并不需要。那如何才能做到，编译之后丢弃这些不用的依赖呢？ 我一开始尝试主动删除，但发现并没有减少 docker 的大小。</p> <p>答案是<a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="noopener noreferrer">Use multi-stage builds<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="编译网站"><a href="#编译网站" class="header-anchor">#</a> 编译网站</h2> <p>首先我们需要安装依赖并编译网站，dockerfile 内容如下：</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14.17.5<span class="token punctuation">-</span>buster<span class="token punctuation">-</span>slim as build
<span class="token keyword">ARG</span> GITHUB_PACKAGES_TOKEN
<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>install<span class="token punctuation">-</span>recommends autoconf automake g++ libpng<span class="token punctuation">-</span>dev make

<span class="token comment"># use changes to package.json to force Docker not to use the cache</span>
<span class="token comment"># when we change our application's nodejs dependencies:</span>
<span class="token keyword">COPY</span> package.json yarn.lock /tmp/
<span class="token keyword">RUN</span> echo $GITHUB_PACKAGES_TOKEN
<span class="token keyword">RUN</span> cd /tmp &amp;&amp; yarn install <span class="token punctuation">-</span><span class="token punctuation">-</span>forzen<span class="token punctuation">-</span>lockfile <span class="token punctuation">-</span><span class="token punctuation">-</span>production=false
<span class="token keyword">RUN</span> mkdir <span class="token punctuation">-</span>p /app &amp;&amp; mv /tmp/node_modules /app
<span class="token comment"># From here we load our application's code in, therefore the previous docker</span>
<span class="token comment"># &quot;layer&quot; thats been cached will be used if possible</span>
<span class="token keyword">WORKDIR</span> /app
<span class="token keyword">COPY</span> . /app
<span class="token keyword">ENV</span> NODE_ENV production
<span class="token keyword">RUN</span> yarn build &amp;&amp; yarn express<span class="token punctuation">:</span>build
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>上面的命令编译了网站和 express 服务端代码，这里选择的 node 官方镜像并不是精简版，因为编译的时候需要很多依赖，精简版的话反而安装系统依赖更花时间。</p> <h2 id="安装依赖"><a href="#安装依赖" class="header-anchor">#</a> 安装依赖</h2> <p>网站运行并不需要 node_modules 但是 express 服务器是需要的，所以我们需要安装后端的依赖。</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14.17.5<span class="token punctuation">-</span>alpine3.14 as deps

<span class="token comment"># use changes to package.json to force Docker not to use the cache</span>
<span class="token comment"># when we change our application's nodejs dependencies:</span>
<span class="token keyword">COPY</span> server/package.json server/yarn.lock /tmp/
<span class="token keyword">RUN</span> cd /tmp &amp;&amp; yarn install <span class="token punctuation">-</span><span class="token punctuation">-</span>forzen<span class="token punctuation">-</span>lockfile <span class="token punctuation">-</span><span class="token punctuation">-</span>production=false
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>服务端的 <code>package.json</code> 文件我放在了 server 文件夹下，服务端依赖的东西很少，所以不太占用空间。</p> <h2 id="打包实际生成的文件"><a href="#打包实际生成的文件" class="header-anchor">#</a> 打包实际生成的文件</h2> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>14.17.5<span class="token punctuation">-</span>alpine3.14
<span class="token keyword">WORKDIR</span> /app
<span class="token keyword">COPY</span> . /app
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=deps /tmp/node_modules ./node_modules/
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=build /app/dist ./dist/
<span class="token keyword">COPY</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>from=build /app/server ./server/
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p>接下来的步骤很简单了， 选择占用空间最小的 <code>Alpine Linux</code> 然后把编译好的文件复制进来就可以了。前两个步骤的所有东西都会被丢弃掉。所以实际生成的 docker 镜像会非常小。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>采用多阶段编译，可以有效的减少编译的依赖对空间的占用，做到最小化 docker 镜像。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p><a href="https://learnk8s.io/blog/smaller-docker-images" target="_blank" rel="noopener noreferrer">3 simple tricks for smaller Docker images<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></article><article class="article"><h1 class="article-title"><a href="/posts/2019-09-23-node-docker/">
          使用Docker运行node项目
        </a></h1> <div class="post-meta"><div class="post-meta-date"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg> <time pubdate itemprop="datePublished" datetime="2019-09-23 22:43">
      2019-09-23 22:43
    </time></div> <div itemprop="keywords" class="post-meta-tags"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-tag"><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7.01" y2="7"></line></svg> <a href="/tags/docker" aria-current="page" class="post-tag router-link-exact-active router-link-active"> docker </a></div></div> <div class="content__default"><p>使用 Docker 容器化开发和部署，是当今的主流。因为程序跑在了容器之内，我们再也不用担心安装各种依赖和版本管理。接下来就来介绍如何使用 Docker 开发自己的 node 项目。</p> <h2 id="使用-docker-compose-管理多个-docker"><a href="#使用-docker-compose-管理多个-docker" class="header-anchor">#</a> 使用 docker-compose 管理多个 Docker</h2> <p>很多情况下，一个 Docker 是满足不了需求的，有时候还要使用 MySQL 数据库，有时候还要使用 redis。这时候就需要使用 docker-compose 来管理多个 Docker。docker-compose 的使用也很简单，只要在项目根目录下建立一个<code>docker-compose.yml</code>文件即可。关于 YAML 的学习，可以参考<a href="https://www.codeproject.com/Articles/1214409/Learn-YAML-in-five-minutes" target="_blank" rel="noopener noreferrer">Learn YAML in five minutes!<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <h2 id="docker-compose-内容定义"><a href="#docker-compose-内容定义" class="header-anchor">#</a> docker-compose 内容定义</h2> <p>首先我们需要声明版本号<code>version</code>，不同的 Docker 版本对 docker-compose 的版本支持也不一样，可以参考官方的文档进行<a href="https://docs.docker.com/compose/compose-file/" target="_blank" rel="noopener noreferrer">对照<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。
然后声明<code>services</code>，service 下的每一个声明都是一个 Docker 的实例。下面介绍一个实际例子：</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">version</span><span class="token punctuation">:</span> <span class="token string">'3.7'</span>
<span class="token key atrule">services</span><span class="token punctuation">:</span>
  <span class="token key atrule">pg</span><span class="token punctuation">:</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> postgres<span class="token punctuation">:</span><span class="token number">9.5</span>
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'${DB_EXPORT_PORT-54320}:5432'</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">POSTGRES_USER</span><span class="token punctuation">:</span> <span class="token string">'${DB_USER-postgres}'</span>
      <span class="token key atrule">POSTGRES_PASSWORD</span><span class="token punctuation">:</span> <span class="token string">'${DB_PASS-123456}'</span>
      <span class="token key atrule">POSTGRES_DB</span><span class="token punctuation">:</span> <span class="token string">'${DB_NAME-dmhy_indexer}'</span>

  <span class="token key atrule">main</span><span class="token punctuation">:</span>
    <span class="token key atrule">build</span><span class="token punctuation">:</span> .
    <span class="token key atrule">cap_add</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> SYS_ADMIN <span class="token comment"># ref https://github.com/GoogleChrome/puppeteer/blob/v1.12.1/docs/troubleshooting.md#running-puppeteer-in-docker</span>
    <span class="token key atrule">image</span><span class="token punctuation">:</span> <span class="token string">'indexer'</span>
    <span class="token key atrule">command</span><span class="token punctuation">:</span> yarn start
    <span class="token key atrule">ports</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'9229:9229'</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">INDEXER_MODE</span><span class="token punctuation">:</span> <span class="token string">'${INDEXER_MODE-dmhy}'</span>
      <span class="token key atrule">DB_HOST</span><span class="token punctuation">:</span> <span class="token string">'${DB_HOST-pg}'</span>
      <span class="token key atrule">DB_PORT</span><span class="token punctuation">:</span> <span class="token string">'${DB_PORT-5432}'</span>
      <span class="token key atrule">DB_USER</span><span class="token punctuation">:</span> <span class="token string">'${DB_USER-postgres}'</span>
      <span class="token key atrule">DB_NAME</span><span class="token punctuation">:</span> <span class="token string">'${DB_NAME-dmhy_indexer}'</span>
      <span class="token key atrule">DB_PASS</span><span class="token punctuation">:</span> <span class="token string">'${DB_PASS-123456}'</span>
    <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token string">'.:/irohalab/indexer'</span>
      <span class="token punctuation">-</span> <span class="token string">'/irohalab/indexer/node_modules'</span>
      <span class="token punctuation">-</span> <span class="token string">'/irohalab/indexer/dist'</span>
    <span class="token key atrule">depends_on</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> pg
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>这个配置来源于<a href="https://github.com/irohalab/indexer" target="_blank" rel="noopener noreferrer">indexer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。我们定义了两个 Service。第一个是数据库 Postgres，第二个便是我们的主项目。首先，我们来看数据库配置，声明了使用官方的<code>postgres:9.5</code>镜像，并映射数据库 5432 端口到主机。这里<code>${DB_EXPORT_PORT-54320}</code>的意思是读取环境变量<code>DB_EXPORT_PORT</code>，如果没有的话就使用默认值<code>54320</code>，这也是 YAML 语法的一部分。接下来又定义了数据库启动需要的环境变量参数。</p> <p>重点是配置的 main 项目，由于 main 项目使用了自定义的 Dockerfile，所以我们需要结合 Dockerfile 的配置来讲述。</p> <div class="language-dockerfile line-numbers-mode"><pre class="language-dockerfile"><code><span class="token keyword">FROM</span> node<span class="token punctuation">:</span>10.16.3<span class="token punctuation">-</span>stretch
<span class="token keyword">RUN</span> apt<span class="token punctuation">-</span>get update <span class="token punctuation">-</span>qq &amp;&amp; apt<span class="token punctuation">-</span>get install <span class="token punctuation">-</span>y gconf<span class="token punctuation">-</span>service libasound2 libatk1.0<span class="token punctuation">-</span>0 libatk<span class="token punctuation">-</span>bridge2.0<span class="token punctuation">-</span>0 libc6 libcairo2 libcups2 libdbus<span class="token punctuation">-</span>1<span class="token punctuation">-</span>3 libexpat1 libfontconfig1 libgcc1 libgconf<span class="token punctuation">-</span>2<span class="token punctuation">-</span>4 libgdk<span class="token punctuation">-</span>pixbuf2.0<span class="token punctuation">-</span>0 libglib2.0<span class="token punctuation">-</span>0 libgtk<span class="token punctuation">-</span>3<span class="token punctuation">-</span>0 libnspr4 libpango<span class="token punctuation">-</span>1.0<span class="token punctuation">-</span>0 libpangocairo<span class="token punctuation">-</span>1.0<span class="token punctuation">-</span>0 libstdc++6 libx11<span class="token punctuation">-</span>6 libx11<span class="token punctuation">-</span>xcb1 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6 ca<span class="token punctuation">-</span>certificates fonts<span class="token punctuation">-</span>liberation libappindicator1 libnss3 lsb<span class="token punctuation">-</span>release xdg<span class="token punctuation">-</span>utils wget
<span class="token keyword">WORKDIR</span> /irohalab/indexer
<span class="token keyword">RUN</span> chown <span class="token punctuation">-</span>R node<span class="token punctuation">:</span>node /irohalab/indexer
<span class="token keyword">RUN</span> usermod <span class="token punctuation">-</span>a <span class="token punctuation">-</span>G audio<span class="token punctuation">,</span>video node
<span class="token keyword">USER</span> node
<span class="token keyword">COPY</span> package.json yarn.lock ./
<span class="token keyword">RUN</span> yarn install
<span class="token keyword">RUN</span> mkdir dist
<span class="token keyword">COPY</span> . .
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>Dockerfile 的第一句话一定是 FROM，代表着是基于哪个官方镜像来自定义。我们基于 node 的 10.16.3 版本来定制镜像，第一步是安装项目额外需要的依赖，第二步是设定工作目录。由于当前项目需要非 root 权限的用户来运行，所以我们需要之后改变权限，ndoe 镜像官方提供了非 root 用户<code>node</code>，所以我们就把工作目录的权限改成了<code>node</code>。接下来是添加到需要的组，之后就是切换用户到<code>node</code>。
切换之前默认 Docker 是使用 root 权限运行的，切换之后就是<code>node</code>用户了，我们 copy 需要的文件之后，执行<code>yarn install</code>来安装，由于存在主机是 Mac，但是 Docker 是 Linux 的情况，所以主机的<code>node_modules</code>并不能直接用，所以我们需要在 Docker 中安装依赖。接下来又创建了一个 dist 目录，然后复制了整个项目。为什么创建<code>dist</code>目录接下来要讲。</p> <h2 id="使用非-root-权限运行"><a href="#使用非-root-权限运行" class="header-anchor">#</a> 使用非 root 权限运行</h2> <p>这部分是 Docker 配置最折腾的地方。因为 Docker 默认是用 root 权限运行的，所以切换到非 root 权限执行程序就会经常遇到 permission denied 的问题。接下来就要讲述 main 部分的配置参数，<code>build: .</code>在当前目录下 build，就是寻找当前目录下的 Dockerfile 并进行 build，<code>cap_add</code>参数是添加<code>Linux capabilities</code>。这部分可以参考<a href="https://docs.docker.com/engine/reference/run/" target="_blank" rel="noopener noreferrer">Runtime privilege and Linux capabilities<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。之所以添加是因为<a href="https://github.com/GoogleChrome/puppeteer/blob/v1.12.1/docs/troubleshooting.md#running-puppeteer-in-docker" target="_blank" rel="noopener noreferrer">puppeteer<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>需要，apt-get 安装的依赖也是。重点是<code>volumes</code>配置，第一行代表当前目录映射到<code>/irohalab/indexer</code>也就是我们设定的工作目录位置。第二行和第三行是为了移除对<code>node_modules</code>文件夹和<code>dist</code>文件夹的映射。但如果 Docker 里没有这两个文件夹就会由 root 来创建，所以我才特地<code>mkdir dist</code>。否则普通用户又会没有权限了。<code>depends_on</code>代表当前镜像的依赖，同时声明依赖之后，Docker 内部之间可以通讯，主机名就是<code>services</code>里定义的名字。</p> <h2 id="使用-dockerignore"><a href="#使用-dockerignore" class="header-anchor">#</a> 使用 dockerignore</h2> <p>dockerignore 和 gitignore 的用法非常类似，当指定了某些文件或文件夹的时候，在执行 COPY 等命令的时候就会忽略这些文件或文件夹。</p> <h2 id="清理-docker"><a href="#清理-docker" class="header-anchor">#</a> 清理 Docker</h2> <p>由于开发过程中各种调试和重新 build，导致产生的无用的镜像数据特别多，所以需要经常清理。官方文档有详细的<a href="https://docs.docker.com/config/pruning/" target="_blank" rel="noopener noreferrer">清理说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>$ docker image prune -a
$ docker system prune --volumes
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>第一个命令会清除所有的镜像，不管有没有使用。第二个命令会清除所有不相关或不使用的 Docker 数据。</p> <h2 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h2> <p>Docker 很强大，但是用起来也没有那么容易。需要不断的尝试，去摸索各种选项的配置和使用。</p> <h2 id="引用"><a href="#引用" class="header-anchor">#</a> 引用</h2> <p><a href="https://www.digitalocean.com/community/tutorials/containerizing-a-node-js-application-for-development-with-docker-compose" target="_blank" rel="noopener noreferrer">Containerizing a Node.js Application for Development With Docker Compose<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.digitalocean.com/community/tutorials/how-to-build-a-node-js-application-with-docker" target="_blank" rel="noopener noreferrer">How To Build a Node.js Application with Docker<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://stackoverflow.com/questions/29181032/add-a-volume-to-docker-but-exclude-a-sub-folder" target="_blank" rel="noopener noreferrer">Add a volume to Docker, but exclude a sub-folder<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://docs.docker.com/engine/reference/builder/#dockerignore-file" target="_blank" rel="noopener noreferrer">.dockerignore file<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></article> <div class="pagination"><div class="pagination-left"><!----></div> <div class="pagination-right"><!----></div></div></section></main></div> <footer class="footer"><div class="footer-left"><ul class="contact"><li class="contact-item"><a href="https://github.com/acgotaku" target="_blank" rel="noopener noreferrer" class="nav-link external"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path></svg>
          
        </a></li><li class="contact-item"><a href="https://twitter.com/acgotaku311" target="_blank" rel="noopener noreferrer" class="nav-link external"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-twitter"><path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path></svg>
          
        </a></li></ul></div> <div class="footer-right"><ul class="copyright"><li class="copyright-item"><a href="https://github.com/acgotaku/IceHoney-BLOG" target="_blank" rel="noopener noreferrer" class="nav-link external">2013 - 2023 © Ice Honey</a></li></ul></div></footer></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.978b3ff5.js" defer></script><script src="/assets/js/4.d187b6e6.js" defer></script><script src="/assets/js/106.2cf3e4f6.js" defer></script><script src="/assets/js/84.b4020175.js" defer></script>
  </body>
</html>
