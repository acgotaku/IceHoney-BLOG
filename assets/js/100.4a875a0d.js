(window.webpackJsonp=window.webpackJsonp||[]).push([[100],{509:function(s,e,t){"use strict";t.r(e);var a=t(10),r=Object(a.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("在工作中有时也会涉及到后端开发，后端开发的性能优化多是查询优化。类似前端 DOM 操作很消耗性能，后端开发数据库查询次数也会相当消耗性能。我们在开发中应该尽量减少 SQL 查询次数，避免 N+1 问题来提升性能。接下来就来介绍数据库查询的 N+1 问题。")]),s._v(" "),t("h2",{attrs:{id:"sql-n-1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql-n-1"}},[s._v("#")]),s._v(" SQL N+1")]),s._v(" "),t("p",[s._v("举一个简单的例子，数据库中有一张 "),t("code",[s._v("cars")]),s._v(" 表存储汽车的相关信息，还有一张 "),t("code",[s._v("wheels")]),s._v(" 表存储汽车的轮胎信息。")]),s._v(" "),t("p",[s._v("查询汽车的语句是：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" cars"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("查询每个汽车的轮子的语句是：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" wheels "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" car_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" ${car_id}"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("这里的 N 就是汽车的数量，如果需要知道每个汽车的轮胎信息那就正好需要查询 "),t("code",[s._v("N+1")]),s._v(" 次。")]),s._v(" "),t("h2",{attrs:{id:"解决-n-1"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#解决-n-1"}},[s._v("#")]),s._v(" 解决 N+1")]),s._v(" "),t("p",[s._v("如果汽车和轮胎是一对一的关系可以通过使用 "),t("code",[s._v("join")]),s._v(" 语句来减少数据库查询次数。把查询降为 1 次。修正之后的查询语句是：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" cars"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" wheels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" cars "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INNER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" wheels "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" wheels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("car_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" cars"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v("如果汽车和轮胎是一对多的关系可以通过使用：")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" cars"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" wheels "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" wheels"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("car_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("IN")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("一次性查询所有需要的轮胎把查询降为两次。")]),s._v(" "),t("h2",{attrs:{id:"现有框架解决方案"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#现有框架解决方案"}},[s._v("#")]),s._v(" 现有框架解决方案")]),s._v(" "),t("h3",{attrs:{id:"django"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#django"}},[s._v("#")]),s._v(" Django")]),s._v(" "),t("p",[s._v("Django 可以使用"),t("a",{attrs:{href:"https://docs.djangoproject.com/en/3.1/ref/models/querysets/#select-related",target:"_blank",rel:"noopener noreferrer"}},[s._v("select-related"),t("OutboundLink")],1),s._v(" 和 "),t("a",{attrs:{href:"https://docs.djangoproject.com/en/3.1/ref/models/querysets/#prefetch-related",target:"_blank",rel:"noopener noreferrer"}},[s._v("prefetch-related"),t("OutboundLink")],1),s._v("来解决这个问题。")]),s._v(" "),t("p",[t("code",[s._v("select-related")]),s._v(" 主要用于一对一的关系，而 "),t("code",[s._v("prefetch-related")]),s._v(" 主要用于多对多或者多对一的关系。")]),s._v(" "),t("h3",{attrs:{id:"ruby-on-rails"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#ruby-on-rails"}},[s._v("#")]),s._v(" Ruby on Rails")]),s._v(" "),t("p",[s._v("使用 "),t("a",{attrs:{href:"https://api.rubyonrails.org/v6.1.3/classes/ActiveRecord/QueryMethods.html#method-i-includes",target:"_blank",rel:"noopener noreferrer"}},[s._v("includes"),t("OutboundLink")],1),s._v(" 来解决 N+1 问题。")]),s._v(" "),t("h2",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结")]),s._v(" "),t("p",[s._v("后端开发需要时刻注意 N+1 问题， 在开发模式下，日志会输出 SQL 查询语句，需要多加注意。也可以使用一些工具来检测这个问题。")]),s._v(" "),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("p",[t("a",{attrs:{href:"https://stackoverflow.com/questions/97197/what-is-the-n1-selects-problem-in-orm-object-relational-mapping",target:"_blank",rel:"noopener noreferrer"}},[s._v("What is the “N+1 selects problem” in ORM"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://guides.rubyonrails.org/active_record_querying.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("Active Record Query Interface"),t("OutboundLink")],1)])])}),[],!1,null,null,null);e.default=r.exports}}]);